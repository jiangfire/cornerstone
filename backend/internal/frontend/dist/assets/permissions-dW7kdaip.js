import{B as e,I as t,c as n,ot as r,rt as i,x as a}from"./index-DONMULiq.js";const o=t(`permissions`,()=>{let t=i(new Map),r=i(new Map),o=i(!1),s=i(`viewer`),c=e(()=>e=>t.value.get(e)||[]),l=e(()=>(e,t)=>{let n=`${e}_${t||s.value}`;return r.value.get(n)}),u=async e=>{o.value=!0;try{let r=await n.getPermissions(e);return r.success&&r.data?.permissions?(t.value.set(e,r.data.permissions),d(r.data.permissions),r.data.permissions):[]}catch(e){return a.error(e instanceof Error?e.message:`加载字段权限失败`),[]}finally{o.value=!1}},d=e=>{e.forEach(e=>{let t=`${e.field_id}_${e.role}`;r.value.set(t,{fieldId:e.field_id,canRead:e.can_read,canWrite:e.can_write,canDelete:e.can_delete})})},f=(e,t,n)=>{let i=n||s.value,a=`${e}_${i}`,o=r.value.get(a);if(!o)switch(i){case`owner`:case`admin`:return!0;case`editor`:return t!==`delete`;case`viewer`:return t===`read`;default:return!1}switch(t){case`read`:return o.canRead;case`write`:return o.canWrite;case`delete`:return o.canDelete;default:return!1}};return{fieldPermissions:t,userPermissions:r,loading:o,currentRole:s,permissionsByTable:c,getFieldPermission:l,loadFieldPermissions:u,checkFieldPermission:f,setFieldPermission:async(e,t)=>{o.value=!0;try{return(await n.setPermission(e,t)).success?(a.success(`权限设置成功`),await u(e),!0):!1}catch(e){return a.error(e instanceof Error?e.message:`权限设置失败`),!1}finally{o.value=!1}},batchSetFieldPermissions:async(e,t)=>{o.value=!0;try{return(await n.batchSetPermissions(e,t)).success?(a.success(`成功设置 ${t.length} 条权限`),await u(e),!0):!1}catch(e){return a.error(e instanceof Error?e.message:`批量权限设置失败`),!1}finally{o.value=!1}},setCurrentRole:e=>{s.value=e},clearPermissions:()=>{t.value.clear(),r.value.clear()},getFieldPermissions:(e,t)=>{let n=`${e}_${t||s.value}`;return r.value.get(n)},filterAuthorizedFields:(e,t=`read`)=>e.filter(e=>f(e.id,t))}});export{o as t};