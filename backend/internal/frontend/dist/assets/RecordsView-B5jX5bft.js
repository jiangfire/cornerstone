const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/api-Al2Zo9Xl.js","assets/index-DONMULiq.js","assets/index-DVLD6Ajo.css"])))=>i.map(i=>d[i]);
import{$ as e,B as t,E as ee,G as n,H as r,J as i,K as a,L as te,M as ne,N as re,Q as ie,S as ae,T as oe,U as o,V as s,W as c,X as l,Y as u,Z as d,at as f,b as p,et as m,f as h,g,it as _,j as se,l as v,n as y,o as ce,ot as le,q as b,rt as x,s as ue,t as de,tt as fe,v as pe,x as S,y as C,z as w}from"./index-DONMULiq.js";import{n as me,t as he}from"./format-BwLcG6eA.js";var ge={class:`records`},_e={class:`card-header`},ve={class:`header-left`},ye={class:`table-name`},be={class:`header-right`},xe={class:`filter-bar`},Se={key:0},Ce={key:1},we={key:2},Te={key:2,class:`pagination`},Ee={key:1,class:`file-section`},De={key:0,class:`upload-progress`},Oe={class:`file-item`},ke={class:`file-name`},Ae={class:`dialog-footer`},je={key:0,class:`file-preview`},Me=[`src`],Ne={key:1},Pe=[`src`],Fe={key:2},T=y(b({__name:`RecordsView`,setup(y){let le=pe(),b=C(),T=le.params.id,E=x(``),D=x(``),O=x(``),k=x(!1),A=x(!1),j=x(!1),M=x(!1),N=x([]),P=x([]),F=x(``),I=x(1),L=x(20),Ie=x(0),R=x(!1),z=x(),B=x({}),V=x(``),H=x(`新建记录`),U=x([]),W=x([]),G=x(0),K=x(!1),q=x(!1),J=x(null),Le=t(()=>M.value),Re=t(()=>[`owner`,`admin`,`editor`].includes(O.value)),ze=t(()=>[`owner`,`admin`,`editor`].includes(O.value)),Be=t(()=>[`owner`,`admin`].includes(O.value)),Ve=t(()=>{let e={};return P.value.forEach(t=>{t.required&&(e[t.name]=[{required:!0,message:`请输入${t.name}`,trigger:`blur`}])}),e}),He=()=>{b.push(`/databases`)},Ue=(e,t)=>e?t===`date`?e.split(` `)[0]:e:`-`,We=e=>({string:150,number:120,boolean:100,date:120,datetime:180,text:200,select:150,multiselect:200})[e]||150,Ge=e=>e?e.split(`,`).map(e=>e.trim()):[],Ke=async()=>{try{let e=await g.getFields(T);e.success&&e.data&&(P.value=e.data.fields||[])}catch(e){console.error(`Failed to load fields:`,e)}},Y=async()=>{try{let e=await g.get(T);if(e.success&&e.data&&(E.value=e.data.name||``,D.value=e.data.database_id||``,D.value)){let e=await ce.getDetail(D.value);e.success&&e.data&&(O.value=e.data.role||`viewer`)}}catch(e){console.error(`Failed to load table info:`,e)}},X=async()=>{k.value=!0;try{let e={table_id:T,limit:L.value,offset:(I.value-1)*L.value,filter:F.value.trim()};F.value.trim()&&(e.filter=F.value.trim());let t=await h.list(e);t.success&&t.data&&(N.value=t.data.records||[],Ie.value=t.data.total||0)}catch{S.error(`加载记录列表失败`)}finally{k.value=!1}},qe=()=>{F.value=``,I.value=1,X()},Z=async()=>{I.value=1,await X()},Je=async e=>{R.value=!0;try{let t=await ue.downloadRecords(T,e,F.value),ee=t instanceof Blob?t:new Blob([t],{type:e===`csv`?`text/csv`:`application/json`}),n=document.createElement(`a`),r=window.URL.createObjectURL(ee);n.href=r,n.download=`${(E.value||T).replace(/[\\/:*?"<>|]/g,`_`)}_${new Date().toISOString().replace(/[:.]/g,`-`)}.${e}`,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(r),S.success(`导出成功`)}catch(e){S.error(e instanceof Error?e.message:`导出失败`)}finally{R.value=!1}},Ye=()=>{M.value=!1,H.value=`新建记录`,V.value=``,B.value={},P.value.forEach(e=>{B.value[e.name]=e.type===`boolean`?!1:void 0}),j.value=!0},Xe=e=>{M.value=!0,H.value=`编辑记录`,V.value=e.id,B.value={...e.data},j.value=!0,Q(e.id)},Ze=async e=>{try{await p.confirm(`确定要删除这条记录吗？`,`警告`,{type:`warning`,confirmButtonText:`确定`,cancelButtonText:`取消`}),(await h.delete(e.id)).success&&(S.success(`删除成功`),await X())}catch(e){e!==`cancel`&&S.error(`删除失败`)}},Qe=async()=>{if(z.value)try{if(!await z.value.validate())return;A.value=!0,M.value?(await h.update(V.value,{data:B.value})).success&&(S.success(`更新成功`),j.value=!1,await X()):(await h.create({table_id:T,data:B.value})).success&&(S.success(`创建成功`),j.value=!1,await X())}catch{S.error(M.value?`更新失败`:`创建失败`)}finally{A.value=!1}},$e=()=>{z.value&&z.value.resetFields(),U.value=[],W.value=[]},Q=async e=>{K.value=!0;try{W.value=(await v.listByRecord(e)).data||[]}catch(e){console.error(`加载附件失败`,e)}finally{K.value=!1}},et=e=>e.size/1024/1024<50?!0:(S.error(`文件大小不能超过50MB`),!1),tt=()=>{S.warning(`最多只能上传5个文件`)},nt=async e=>{if(!V.value){S.warning(`请先保存记录后再上传文件`);return}G.value=0;try{let t=new FormData;t.append(`record_id`,V.value),t.append(`file`,e.raw),await(await de(async()=>{let{default:e}=await import(`./api-Al2Zo9Xl.js`);return{default:e}},__vite__mapDeps([0,1,2]))).default.post(`/files/upload`,t,{headers:{"Content-Type":`multipart/form-data`},onUploadProgress:e=>{G.value=Math.floor(e.loaded*100/(e.total||1))}}),S.success(`文件上传成功`),Q(V.value),U.value=[],G.value=0}catch{S.error(`文件上传失败`),G.value=0}},rt=e=>{let t=e.file_name.split(`.`).pop()?.toLowerCase();J.value={id:e.id,url:v.download(e.id),isImage:[`jpg`,`jpeg`,`png`,`gif`,`bmp`,`webp`].includes(t||``),isPdf:t===`pdf`},q.value=!0},it=e=>{let t=v.download(e.id);window.open(t,`_blank`)},at=async e=>{try{await p.confirm(`确定要删除该文件吗？`,`提示`,{type:`warning`}),await v.delete(e.id),S.success(`删除成功`),Q(V.value)}catch(e){e!==`cancel`&&S.error(`删除失败`)}},$=null;return e(F,()=>{$&&clearTimeout($),$=setTimeout(()=>{F.value===``?X():Z()},300)}),i(()=>{Y(),Ke(),X()}),(e,t)=>{let i=d(`el-icon`),p=d(`el-button`),h=d(`el-dropdown-item`),g=d(`el-dropdown-menu`),v=d(`el-dropdown`),y=d(`el-input`),ce=d(`el-empty`),le=d(`el-tag`),b=d(`el-table-column`),x=d(`el-table`),ue=d(`el-pagination`),de=d(`el-card`),pe=d(`el-input-number`),S=d(`el-switch`),C=d(`el-date-picker`),T=d(`el-option`),D=d(`el-select`),O=d(`el-form-item`),M=d(`el-form`),V=d(`el-divider`),Ke=d(`el-upload`),Y=d(`el-progress`),Q=d(`el-dialog`),$=d(`el-result`),ot=ie(`loading`);return u(),c(`div`,ge,[a(de,{class:`box-card`},{header:m(()=>[s(`div`,_e,[s(`div`,ve,[a(p,{link:``,onClick:He},{default:m(()=>[a(i,null,{default:m(()=>[a(_(ae))]),_:1}),t[7]||=n(` 返回表列表 `,-1)]),_:1}),s(`span`,ye,f(E.value)+` - 数据记录`,1)]),s(`div`,be,[a(p,{onClick:qe},{default:m(()=>[a(i,null,{default:m(()=>[a(_(se))]),_:1}),t[8]||=n(` 刷新 `,-1)]),_:1}),a(v,{onCommand:Je,disabled:R.value},{dropdown:m(()=>[a(g,null,{default:m(()=>[a(h,{command:`csv`},{default:m(()=>[...t[10]||=[n(`导出 CSV`,-1)]]),_:1}),a(h,{command:`json`},{default:m(()=>[...t[11]||=[n(`导出 JSON`,-1)]]),_:1})]),_:1})]),default:m(()=>[a(p,{loading:R.value},{default:m(()=>[a(i,null,{default:m(()=>[a(_(ee))]),_:1}),t[9]||=n(` 导出 `,-1)]),_:1},8,[`loading`])]),_:1},8,[`disabled`]),Re.value?(u(),r(p,{key:0,type:`primary`,onClick:Ye},{default:m(()=>[...t[12]||=[n(`新建记录`,-1)]]),_:1})):o(``,!0)])])]),default:m(()=>[s(`div`,xe,[a(y,{modelValue:F.value,"onUpdate:modelValue":t[0]||=e=>F.value=e,placeholder:`搜索记录...`,clearable:``,style:{width:`300px`},onClear:X,onKeyup:te(Z,[`enter`])},{append:m(()=>[a(p,{icon:_(ne),onClick:Z},null,8,[`icon`])]),_:1},8,[`modelValue`])]),N.value.length===0?(u(),r(ce,{key:0,description:`暂无数据记录`},{default:m(()=>[Re.value?(u(),r(p,{key:0,type:`primary`,onClick:Ye},{default:m(()=>[...t[13]||=[n(`创建记录`,-1)]]),_:1})):o(``,!0)]),_:1})):fe((u(),r(x,{key:1,data:N.value,style:{width:`100%`},border:``},{default:m(()=>[(u(!0),c(w,null,l(P.value,e=>(u(),r(b,{key:e.id,prop:e.name,label:e.name,"min-width":We(e.type)},{default:m(({row:t})=>[e.type===`boolean`?(u(),c(`span`,Se,[a(le,{type:t.data[e.name]?`success`:`info`},{default:m(()=>[n(f(t.data[e.name]?`是`:`否`),1)]),_:2},1032,[`type`])])):e.type===`date`||e.type===`datetime`?(u(),c(`span`,Ce,f(Ue(t.data[e.name],e.type)),1)):(u(),c(`span`,we,f(t.data[e.name]||`-`),1))]),_:2},1032,[`prop`,`label`,`min-width`]))),128)),a(b,{prop:`created_at`,label:`创建时间`,width:`180`,fixed:`right`},{default:m(({row:e})=>[n(f(_(he)(e.created_at)),1)]),_:1}),a(b,{label:`操作`,width:`150`,fixed:`right`},{default:m(({row:e})=>[ze.value?(u(),r(p,{key:0,size:`small`,onClick:t=>Xe(e)},{default:m(()=>[...t[14]||=[n(`编辑`,-1)]]),_:1},8,[`onClick`])):o(``,!0),Be.value?(u(),r(p,{key:1,size:`small`,type:`danger`,onClick:t=>Ze(e)},{default:m(()=>[...t[15]||=[n(`删除`,-1)]]),_:1},8,[`onClick`])):o(``,!0)]),_:1})]),_:1},8,[`data`])),[[ot,k.value]]),N.value.length>0?(u(),c(`div`,Te,[a(ue,{"current-page":I.value,"onUpdate:currentPage":t[1]||=e=>I.value=e,"page-size":L.value,"onUpdate:pageSize":t[2]||=e=>L.value=e,"page-sizes":[10,20,50,100],total:Ie.value,layout:`total, sizes, prev, pager, next, jumper`,onSizeChange:X,onCurrentChange:X},null,8,[`current-page`,`page-size`,`total`])])):o(``,!0)]),_:1}),a(Q,{modelValue:j.value,"onUpdate:modelValue":t[4]||=e=>j.value=e,title:H.value,width:`700px`,onClose:$e},{footer:m(()=>[s(`span`,Ae,[a(p,{onClick:t[3]||=e=>j.value=!1},{default:m(()=>[...t[22]||=[n(`取消`,-1)]]),_:1}),a(p,{type:`primary`,onClick:Qe,loading:A.value},{default:m(()=>[...t[23]||=[n(` 确定 `,-1)]]),_:1},8,[`loading`])])]),default:m(()=>[a(M,{ref_key:`formRef`,ref:z,model:B.value,rules:Ve.value,"label-width":`120px`,loading:A.value},{default:m(()=>[(u(!0),c(w,null,l(P.value,e=>(u(),r(O,{key:e.id,label:e.name,prop:e.name},{default:m(()=>[e.type===`string`?(u(),r(y,{key:0,modelValue:B.value[e.name],"onUpdate:modelValue":t=>B.value[e.name]=t,placeholder:`请输入${e.name}`},null,8,[`modelValue`,`onUpdate:modelValue`,`placeholder`])):e.type===`number`?(u(),r(pe,{key:1,modelValue:B.value[e.name],"onUpdate:modelValue":t=>B.value[e.name]=t,placeholder:`请输入${e.name}`,style:{width:`100%`}},null,8,[`modelValue`,`onUpdate:modelValue`,`placeholder`])):e.type===`boolean`?(u(),r(S,{key:2,modelValue:B.value[e.name],"onUpdate:modelValue":t=>B.value[e.name]=t},null,8,[`modelValue`,`onUpdate:modelValue`])):e.type===`date`?(u(),r(C,{key:3,modelValue:B.value[e.name],"onUpdate:modelValue":t=>B.value[e.name]=t,type:`date`,placeholder:`请选择${e.name}`,style:{width:`100%`},"value-format":`YYYY-MM-DD`},null,8,[`modelValue`,`onUpdate:modelValue`,`placeholder`])):e.type===`datetime`?(u(),r(C,{key:4,modelValue:B.value[e.name],"onUpdate:modelValue":t=>B.value[e.name]=t,type:`datetime`,placeholder:`请选择${e.name}`,style:{width:`100%`},"value-format":`YYYY-MM-DD HH:mm:ss`},null,8,[`modelValue`,`onUpdate:modelValue`,`placeholder`])):e.type===`text`?(u(),r(y,{key:5,modelValue:B.value[e.name],"onUpdate:modelValue":t=>B.value[e.name]=t,type:`textarea`,rows:4,placeholder:`请输入${e.name}`},null,8,[`modelValue`,`onUpdate:modelValue`,`placeholder`])):e.type===`select`?(u(),r(D,{key:6,modelValue:B.value[e.name],"onUpdate:modelValue":t=>B.value[e.name]=t,placeholder:`请选择${e.name}`,style:{width:`100%`}},{default:m(()=>[(u(!0),c(w,null,l(Ge(e.options),e=>(u(),r(T,{key:e,label:e,value:e},null,8,[`label`,`value`]))),128))]),_:2},1032,[`modelValue`,`onUpdate:modelValue`,`placeholder`])):e.type===`multiselect`?(u(),r(D,{key:7,modelValue:B.value[e.name],"onUpdate:modelValue":t=>B.value[e.name]=t,placeholder:`请选择${e.name}`,style:{width:`100%`},multiple:``},{default:m(()=>[(u(!0),c(w,null,l(Ge(e.options),e=>(u(),r(T,{key:e,label:e,value:e},null,8,[`label`,`value`]))),128))]),_:2},1032,[`modelValue`,`onUpdate:modelValue`,`placeholder`])):o(``,!0)]),_:2},1032,[`label`,`prop`]))),128))]),_:1},8,[`model`,`rules`,`loading`]),Le.value?(u(),r(V,{key:0},{default:m(()=>[...t[16]||=[n(`附件管理`,-1)]]),_:1})):o(``,!0),Le.value?(u(),c(`div`,Ee,[a(Ke,{"auto-upload":!1,"on-change":nt,"file-list":U.value,limit:5,"on-exceed":tt,"before-upload":et},{tip:m(()=>[...t[18]||=[s(`div`,{class:`el-upload__tip`},`支持上传图片、文档、压缩包等文件，单文件不超过50MB`,-1)]]),default:m(()=>[a(p,{size:`small`,type:`primary`},{default:m(()=>[a(i,null,{default:m(()=>[a(_(re))]),_:1}),t[17]||=n(` 选择文件 `,-1)]),_:1})]),_:1},8,[`file-list`]),G.value>0&&G.value<100?(u(),c(`div`,De,[a(Y,{percentage:G.value},null,8,[`percentage`])])):o(``,!0),W.value.length>0?fe((u(),r(x,{key:1,data:W.value,style:{width:`100%`,"margin-top":`20px`}},{default:m(()=>[a(b,{label:`文件`,"min-width":`200`},{default:m(({row:e})=>[s(`div`,Oe,[a(i,{class:`file-icon`},{default:m(()=>[a(_(oe))]),_:1}),s(`span`,ke,f(e.file_name),1)])]),_:1}),a(b,{prop:`file_size`,label:`大小`,width:`100`},{default:m(({row:e})=>[n(f(_(me)(e.file_size)),1)]),_:1}),a(b,{prop:`created_at`,label:`上传时间`,width:`180`},{default:m(({row:e})=>[n(f(_(he)(e.created_at)),1)]),_:1}),a(b,{label:`操作`,width:`180`},{default:m(({row:e})=>[a(p,{size:`small`,onClick:t=>rt(e)},{default:m(()=>[...t[19]||=[n(`预览`,-1)]]),_:1},8,[`onClick`]),a(p,{size:`small`,onClick:t=>it(e)},{default:m(()=>[...t[20]||=[n(`下载`,-1)]]),_:1},8,[`onClick`]),a(p,{size:`small`,type:`danger`,onClick:t=>at(e)},{default:m(()=>[...t[21]||=[n(`删除`,-1)]]),_:1},8,[`onClick`])]),_:1})]),_:1},8,[`data`])),[[ot,K.value]]):o(``,!0)])):o(``,!0)]),_:1},8,[`modelValue`,`title`]),a(Q,{modelValue:q.value,"onUpdate:modelValue":t[6]||=e=>q.value=e,title:`文件预览`,width:`800px`},{default:m(()=>[J.value?(u(),c(`div`,je,[J.value.isImage?(u(),c(`img`,{key:0,src:J.value.url,style:{"max-width":`100%`}},null,8,Me)):J.value.isPdf?(u(),c(`div`,Ne,[s(`iframe`,{src:J.value.url,style:{width:`100%`,height:`600px`}},null,8,Pe)])):(u(),c(`div`,Fe,[a($,{icon:`warning`,title:`无法预览`,"sub-title":`此文件类型不支持预览，请下载后查看`},{extra:m(()=>[a(p,{type:`primary`,onClick:t[5]||=e=>it(J.value)},{default:m(()=>[...t[24]||=[n(`下载文件`,-1)]]),_:1})]),_:1})]))])):o(``,!0)]),_:1},8,[`modelValue`])])}}}),[[`__scopeId`,`data-v-180ea3d3`]]);export{T as default};