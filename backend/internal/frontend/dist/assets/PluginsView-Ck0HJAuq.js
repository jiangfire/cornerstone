import{G as e,H as t,J as n,K as r,Q as ee,U as i,V as a,W as o,X as s,Y as c,Z as l,at as u,b as d,d as f,et as p,it as m,n as h,o as g,ot as _,q as v,rt as y,tt as b,x,z as S}from"./index-DONMULiq.js";import{t as C}from"./format-BwLcG6eA.js";var w={class:`plugins`},T={class:`card-header`},te={key:0,style:{"margin-left":`10px`}},E=h(v({__name:`PluginsView`,setup(h){let _=y(!1),v=y(!1),E=y(!1),D=y(!1),O=y([]),k=y([]),A=y(!1),j=y(!1),M=y(!1),N=y(!1),P=y(!1),F=y(null),I=y([]),L=y(!1),R=y([]),z=y({name:``,description:``,language:`go`,entry_file:``,timeout:30,config:``,config_values:``}),B=y({table_id:``,trigger:`manual`}),V=async()=>{D.value=!0;try{let e=(await g.list()).data?.databases||[];k.value=(await Promise.all(e.map(async e=>(await g.getTables(e.id)).data?.tables||[]))).flat().map(e=>({id:e.id,name:e.name}))}catch{x.error(`加载可绑定表失败`),k.value=[]}finally{D.value=!1}},H=async()=>{_.value=!0;try{O.value=(await f.list()).data||[]}catch(e){x.error(e instanceof Error?e.message:`加载插件列表失败`)}finally{_.value=!1}},U=()=>{P.value=!1,z.value={name:``,description:``,language:`go`,entry_file:``,timeout:30,config:``,config_values:``},R.value=[],A.value=!0},W=e=>{P.value=!0,F.value=e,z.value={name:e.name,description:e.description,language:e.language,entry_file:e.entry_file,timeout:e.timeout,config:e.config||``,config_values:e.config_values||``},e.config?R.value=X(e.config):R.value=[],A.value=!0},G=async()=>{v.value=!0;try{z.value.config=R.value.length>0?JSON.stringify(R.value):``,P.value&&F.value?(await f.update(F.value.id,{name:z.value.name,description:z.value.description,timeout:z.value.timeout,config:z.value.config,config_values:z.value.config_values}),x.success(`更新成功`)):(await f.create({name:z.value.name,description:z.value.description,language:z.value.language,entry_file:z.value.entry_file,timeout:z.value.timeout,config:z.value.config,config_values:z.value.config_values}),x.success(`创建成功`)),A.value=!1,H()}catch{x.error(`操作失败`)}finally{v.value=!1}},K=async e=>{try{await d.confirm(`确定要删除该插件吗？`,`提示`,{type:`warning`}),await f.delete(e.id),x.success(`删除成功`),H()}catch(e){e!==`cancel`&&x.error(`删除失败`)}},q=async e=>{F.value=e,await V(),B.value={table_id:``,trigger:`manual`},j.value=!0},J=async()=>{if(F.value){E.value=!0;try{await f.bind(F.value.id,B.value),x.success(`绑定成功`),j.value=!1}catch{x.error(`绑定失败`)}finally{E.value=!1}}},ne=e=>({go:`success`,python:`warning`,bash:`info`})[e]||``,re=async e=>{F.value=e,M.value=!0,await Y(e.id)},Y=async e=>{L.value=!0;try{I.value=(await f.getBindings(e)).data||[]}catch{x.error(`加载绑定列表失败`)}finally{L.value=!1}},ie=async e=>{if(F.value)try{await d.confirm(`确定要解绑表"${e.table_name}"吗？`,`提示`,{type:`warning`}),await f.unbind(F.value.id,{table_id:e.table_id}),x.success(`解绑成功`),await Y(F.value.id)}catch(e){e!==`cancel`&&x.error(`解绑失败`)}},ae=e=>({create:`创建时`,update:`更新时`,delete:`删除时`,manual:`手动触发`})[e]||e,oe=e=>({create:`success`,update:`warning`,delete:`danger`,manual:`info`})[e]||``,X=e=>{try{return JSON.parse(e||`[]`)}catch{return[]}},se=()=>{N.value=!0},ce=()=>{R.value.push({name:``,type:`string`,default:``,required:!1})},le=e=>{R.value.splice(e,1)};return n(()=>{H()}),(n,d)=>{let f=l(`el-button`),h=l(`el-table-column`),g=l(`el-tag`),y=l(`el-table`),x=l(`el-card`),F=l(`el-input`),V=l(`el-form-item`),H=l(`el-option`),Y=l(`el-select`),ue=l(`el-input-number`),Z=l(`el-form`),Q=l(`el-dialog`),de=l(`el-empty`),fe=l(`el-switch`),$=ee(`loading`);return c(),o(`div`,w,[r(x,{class:`box-card`},{header:p(()=>[a(`div`,T,[d[16]||=a(`span`,null,`插件管理`,-1),r(f,{type:`primary`,onClick:U},{default:p(()=>[...d[15]||=[e(`创建插件`,-1)]]),_:1})])]),default:p(()=>[b((c(),t(y,{data:O.value,style:{width:`100%`}},{default:p(()=>[r(h,{prop:`name`,label:`插件名称`,"min-width":`150`}),r(h,{prop:`language`,label:`语言`,width:`100`},{default:p(({row:t})=>[r(g,{type:ne(t.language)},{default:p(()=>[e(u(t.language),1)]),_:2},1032,[`type`])]),_:1}),r(h,{prop:`description`,label:`描述`,"min-width":`200`}),r(h,{prop:`timeout`,label:`超时(秒)`,width:`100`}),r(h,{label:`操作`,width:`320`,fixed:`right`},{default:p(({row:t})=>[r(f,{size:`small`,onClick:e=>W(t)},{default:p(()=>[...d[17]||=[e(`编辑`,-1)]]),_:1},8,[`onClick`]),r(f,{size:`small`,type:`info`,onClick:e=>re(t)},{default:p(()=>[...d[18]||=[e(`查看绑定`,-1)]]),_:1},8,[`onClick`]),r(f,{size:`small`,type:`primary`,onClick:e=>q(t)},{default:p(()=>[...d[19]||=[e(`绑定`,-1)]]),_:1},8,[`onClick`]),r(f,{size:`small`,type:`danger`,onClick:e=>K(t)},{default:p(()=>[...d[20]||=[e(`删除`,-1)]]),_:1},8,[`onClick`])]),_:1})]),_:1},8,[`data`])),[[$,_.value]])]),_:1}),r(Q,{modelValue:A.value,"onUpdate:modelValue":d[6]||=e=>A.value=e,title:P.value?`编辑插件`:`创建插件`,width:`500px`},{footer:p(()=>[r(f,{onClick:d[5]||=e=>A.value=!1},{default:p(()=>[...d[22]||=[e(`取消`,-1)]]),_:1}),r(f,{type:`primary`,onClick:G,loading:v.value},{default:p(()=>[...d[23]||=[e(`确定`,-1)]]),_:1},8,[`loading`])]),default:p(()=>[r(Z,{model:z.value,"label-width":`100px`},{default:p(()=>[r(V,{label:`插件名称`},{default:p(()=>[r(F,{modelValue:z.value.name,"onUpdate:modelValue":d[0]||=e=>z.value.name=e,placeholder:`请输入插件名称`},null,8,[`modelValue`])]),_:1}),r(V,{label:`描述`},{default:p(()=>[r(F,{modelValue:z.value.description,"onUpdate:modelValue":d[1]||=e=>z.value.description=e,type:`textarea`,rows:`3`},null,8,[`modelValue`])]),_:1}),P.value?i(``,!0):(c(),t(V,{key:0,label:`语言`},{default:p(()=>[r(Y,{modelValue:z.value.language,"onUpdate:modelValue":d[2]||=e=>z.value.language=e,placeholder:`请选择语言`},{default:p(()=>[r(H,{label:`Go`,value:`go`}),r(H,{label:`Python`,value:`python`}),r(H,{label:`Bash`,value:`bash`})]),_:1},8,[`modelValue`])]),_:1})),P.value?i(``,!0):(c(),t(V,{key:1,label:`入口文件`},{default:p(()=>[r(F,{modelValue:z.value.entry_file,"onUpdate:modelValue":d[3]||=e=>z.value.entry_file=e,placeholder:`main.go / main.py / main.sh`},null,8,[`modelValue`])]),_:1})),r(V,{label:`超时(秒)`},{default:p(()=>[r(ue,{modelValue:z.value.timeout,"onUpdate:modelValue":d[4]||=e=>z.value.timeout=e,min:1,max:300},null,8,[`modelValue`])]),_:1}),P.value?i(``,!0):(c(),t(V,{key:2,label:`配置参数`},{default:p(()=>[r(f,{size:`small`,onClick:se},{default:p(()=>[...d[21]||=[e(`配置参数`,-1)]]),_:1}),z.value.config&&z.value.config.length>0?(c(),o(`span`,te,` 已配置 `+u(X(z.value.config).length)+` 个参数 `,1)):i(``,!0)]),_:1}))]),_:1},8,[`model`])]),_:1},8,[`modelValue`,`title`]),r(Q,{modelValue:j.value,"onUpdate:modelValue":d[10]||=e=>j.value=e,title:`绑定插件到表`,width:`500px`},{footer:p(()=>[r(f,{onClick:d[9]||=e=>j.value=!1},{default:p(()=>[...d[24]||=[e(`取消`,-1)]]),_:1}),r(f,{type:`primary`,onClick:J,loading:E.value},{default:p(()=>[...d[25]||=[e(`确定`,-1)]]),_:1},8,[`loading`])]),default:p(()=>[r(Z,{model:B.value,"label-width":`100px`},{default:p(()=>[r(V,{label:`选择表`},{default:p(()=>[r(Y,{modelValue:B.value.table_id,"onUpdate:modelValue":d[7]||=e=>B.value.table_id=e,placeholder:`请选择表`,filterable:``,loading:D.value},{default:p(()=>[(c(!0),o(S,null,s(k.value,e=>(c(),t(H,{key:e.id,label:e.name,value:e.id},null,8,[`label`,`value`]))),128))]),_:1},8,[`modelValue`,`loading`])]),_:1}),r(V,{label:`触发器`},{default:p(()=>[r(Y,{modelValue:B.value.trigger,"onUpdate:modelValue":d[8]||=e=>B.value.trigger=e,placeholder:`请选择触发器`},{default:p(()=>[r(H,{label:`创建记录时`,value:`create`}),r(H,{label:`更新记录时`,value:`update`}),r(H,{label:`删除记录时`,value:`delete`}),r(H,{label:`手动触发`,value:`manual`})]),_:1},8,[`modelValue`])]),_:1})]),_:1},8,[`model`])]),_:1},8,[`modelValue`]),r(Q,{modelValue:M.value,"onUpdate:modelValue":d[11]||=e=>M.value=e,title:`插件绑定管理`,width:`700px`},{default:p(()=>[b((c(),t(y,{data:I.value,style:{width:`100%`}},{default:p(()=>[r(h,{prop:`database_name`,label:`数据库`}),r(h,{prop:`table_name`,label:`表名`}),r(h,{prop:`trigger`,label:`触发器`,width:`120`},{default:p(({row:t})=>[r(g,{type:oe(t.trigger)},{default:p(()=>[e(u(ae(t.trigger)),1)]),_:2},1032,[`type`])]),_:1}),r(h,{prop:`created_at`,label:`绑定时间`,width:`180`},{default:p(({row:t})=>[e(u(m(C)(t.created_at)),1)]),_:1}),r(h,{label:`操作`,width:`100`},{default:p(({row:t})=>[r(f,{size:`small`,type:`danger`,onClick:e=>ie(t)},{default:p(()=>[...d[26]||=[e(`解绑`,-1)]]),_:1},8,[`onClick`])]),_:1})]),_:1},8,[`data`])),[[$,L.value]]),I.value.length===0?(c(),t(de,{key:0,description:`暂无绑定`})):i(``,!0)]),_:1},8,[`modelValue`]),r(Q,{modelValue:N.value,"onUpdate:modelValue":d[14]||=e=>N.value=e,title:`配置插件参数`,width:`700px`},{footer:p(()=>[r(f,{onClick:d[12]||=e=>N.value=!1},{default:p(()=>[...d[29]||=[e(`取消`,-1)]]),_:1}),r(f,{type:`primary`,onClick:d[13]||=e=>N.value=!1},{default:p(()=>[...d[30]||=[e(`确定`,-1)]]),_:1})]),default:p(()=>[r(f,{onClick:ce,style:{"margin-bottom":`15px`}},{default:p(()=>[...d[27]||=[e(`+ 添加参数`,-1)]]),_:1}),r(y,{data:R.value,style:{width:`100%`}},{default:p(()=>[r(h,{prop:`name`,label:`参数名`,width:`150`},{default:p(({row:e})=>[r(F,{modelValue:e.name,"onUpdate:modelValue":t=>e.name=t,placeholder:`参数名`,size:`small`},null,8,[`modelValue`,`onUpdate:modelValue`])]),_:1}),r(h,{prop:`type`,label:`类型`,width:`120`},{default:p(({row:e})=>[r(Y,{modelValue:e.type,"onUpdate:modelValue":t=>e.type=t,size:`small`},{default:p(()=>[r(H,{label:`字符串`,value:`string`}),r(H,{label:`数字`,value:`number`}),r(H,{label:`布尔`,value:`boolean`}),r(H,{label:`下拉选择`,value:`select`})]),_:1},8,[`modelValue`,`onUpdate:modelValue`])]),_:1}),r(h,{prop:`default`,label:`默认值`,width:`120`},{default:p(({row:e})=>[r(F,{modelValue:e.default,"onUpdate:modelValue":t=>e.default=t,placeholder:`默认值`,size:`small`},null,8,[`modelValue`,`onUpdate:modelValue`])]),_:1}),r(h,{prop:`required`,label:`必填`,width:`80`},{default:p(({row:e})=>[r(fe,{modelValue:e.required,"onUpdate:modelValue":t=>e.required=t},null,8,[`modelValue`,`onUpdate:modelValue`])]),_:1}),r(h,{label:`操作`,width:`80`},{default:p(({$index:t})=>[r(f,{size:`small`,type:`danger`,onClick:e=>le(t)},{default:p(()=>[...d[28]||=[e(` 删除 `,-1)]]),_:1},8,[`onClick`])]),_:1})]),_:1},8,[`data`])]),_:1},8,[`modelValue`])])}}}),[[`__scopeId`,`data-v-fbfd56a3`]]);export{E as default};