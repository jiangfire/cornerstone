import{B as e,G as t,H as n,J as r,K as i,Q as a,S as o,U as s,V as c,W as l,Y as u,Z as d,at as f,b as p,c as m,et as h,g,it as _,n as v,ot as y,q as b,rt as x,tt as S,v as C,x as w,y as T}from"./index-DONMULiq.js";import{t as E}from"./format-BwLcG6eA.js";import{t as D}from"./permissions-dW7kdaip.js";var ee={class:`fields`},O={class:`card-header`},k={class:`header-left`},A={class:`table-name`},j={class:`header-actions`},M={key:2,style:{color:`#909399`,"font-size":`12px`}},N={class:`dialog-footer`},P=v(b({__name:`FieldsView`,setup(v){let y=C(),b=T(),P=y.params.id,F=x(``),I=D(),L=x(!1),R=x(!1),z=x(!1),B=x(!1),V=x([]),H=x(),U=x({name:``,type:`string`,required:!1,options:``,id:``}),W={name:[{required:!0,message:`请输入字段名称`,trigger:`blur`},{min:2,max:100,message:`长度在 2-100 个字符之间`,trigger:`blur`}],type:[{required:!0,message:`请选择字段类型`,trigger:`change`}],options:[{validator:(e,t,n)=>{(U.value.type===`select`||U.value.type===`multiselect`)&&!t?n(Error(`下拉/多选字段必须配置选项`)):n()},trigger:`blur`}]},G=x(`添加字段`),K=e(()=>V.value.filter(e=>I.checkFieldPermission(e.id,`read`))),q=e(()=>!0),J=()=>{b.push(`/databases`)},Y=()=>{b.push(`/tables/${P}/field-permissions`)},X=e=>({string:`字符串`,number:`数字`,boolean:`布尔值`,date:`日期`,datetime:`日期时间`,text:`文本`,select:`下拉选择`,multiselect:`多选`})[e]||e,Z=e=>({string:``,number:`success`,boolean:`warning`,date:`info`,datetime:`info`,text:``,select:`success`,multiselect:`success`})[e]||``,Q=async()=>{L.value=!0;try{let e=await g.getFields(P);e.success&&e.data&&(V.value=e.data.fields||[]),await I.loadFieldPermissions(P)}catch{w.error(`加载字段列表失败`)}finally{L.value=!1}},te=async()=>{try{let e=await g.get(P);e.success&&e.data&&(F.value=e.data.name||``)}catch(e){console.error(`Failed to load table info:`,e)}},$=()=>{if(!q.value){w.warning(`您没有创建字段的权限`);return}B.value=!1,G.value=`添加字段`,U.value={name:``,type:`string`,required:!1,options:``,id:``},z.value=!0},ne=e=>{if(!I.checkFieldPermission(e.id,`write`)){w.warning(`您没有编辑此字段的权限`);return}B.value=!0,G.value=`编辑字段`,U.value={name:e.name,type:e.type,required:e.required,options:e.options||``,id:e.id},z.value=!0},re=async e=>{if(!I.checkFieldPermission(e.id,`delete`)){w.warning(`您没有删除此字段的权限`);return}try{await p.confirm(`确定要删除字段 "${e.name}" 吗？`,`警告`,{type:`warning`,confirmButtonText:`确定`,cancelButtonText:`取消`}),(await m.delete(e.id)).success&&(w.success(`删除成功`),await Q())}catch(e){e!==`cancel`&&w.error(`删除失败`)}},ie=async()=>{if(H.value)try{if(!await H.value.validate())return;R.value=!0,B.value?(await m.update(U.value.id,{name:U.value.name,type:U.value.type,required:U.value.required,options:U.value.options})).success&&(w.success(`更新成功`),z.value=!1,await Q()):(await m.create({table_id:P,name:U.value.name,type:U.value.type,required:U.value.required,options:U.value.options})).success&&(w.success(`添加成功`),z.value=!1,await Q())}catch{w.error(B.value?`更新失败`:`添加失败`)}finally{R.value=!1}},ae=()=>{H.value&&H.value.resetFields()};return r(()=>{te(),Q()}),(e,r)=>{let p=d(`el-icon`),m=d(`el-button`),g=d(`el-empty`),v=d(`el-table-column`),y=d(`el-tag`),b=d(`el-table`),x=d(`el-card`),C=d(`el-input`),w=d(`el-form-item`),T=d(`el-option`),D=d(`el-select`),P=d(`el-switch`),B=d(`el-form`),V=d(`el-dialog`),Q=a(`loading`);return u(),l(`div`,ee,[i(x,{class:`box-card`},{header:h(()=>[c(`div`,O,[c(`div`,k,[i(m,{link:``,onClick:J},{default:h(()=>[i(p,null,{default:h(()=>[i(_(o))]),_:1}),r[6]||=t(` 返回表列表 `,-1)]),_:1}),c(`span`,A,f(F.value)+` - 字段管理`,1)]),c(`div`,j,[i(m,{onClick:Y},{default:h(()=>[...r[7]||=[t(`权限配置`,-1)]]),_:1}),i(m,{type:`primary`,onClick:$},{default:h(()=>[...r[8]||=[t(`添加字段`,-1)]]),_:1})])])]),default:h(()=>[K.value.length===0?(u(),n(g,{key:0,description:`暂无字段，请添加您的第一个字段`},{default:h(()=>[q.value?(u(),n(m,{key:0,type:`primary`,onClick:$},{default:h(()=>[...r[9]||=[t(`添加字段`,-1)]]),_:1})):s(``,!0)]),_:1})):S((u(),n(b,{key:1,data:K.value,style:{width:`100%`}},{default:h(()=>[i(v,{prop:`name`,label:`字段名称`,"min-width":`180`}),i(v,{prop:`type`,label:`字段类型`,width:`120`},{default:h(({row:e})=>[i(y,{type:Z(e.type)},{default:h(()=>[t(f(X(e.type)),1)]),_:2},1032,[`type`])]),_:1}),i(v,{prop:`required`,label:`必填`,width:`80`,align:`center`},{default:h(({row:e})=>[i(y,{type:e.required?`danger`:`info`},{default:h(()=>[t(f(e.required?`是`:`否`),1)]),_:2},1032,[`type`])]),_:1}),i(v,{prop:`options`,label:`配置选项`,"min-width":`200`,"show-overflow-tooltip":``}),i(v,{prop:`created_at`,label:`创建时间`,width:`180`},{default:h(({row:e})=>[t(f(_(E)(e.created_at)),1)]),_:1}),i(v,{label:`操作`,width:`150`,fixed:`right`},{default:h(({row:e})=>[_(I).checkFieldPermission(e.id,`write`)?(u(),n(m,{key:0,size:`small`,onClick:t=>ne(e)},{default:h(()=>[...r[10]||=[t(` 编辑 `,-1)]]),_:1},8,[`onClick`])):s(``,!0),_(I).checkFieldPermission(e.id,`delete`)?(u(),n(m,{key:1,size:`small`,type:`danger`,onClick:t=>re(e)},{default:h(()=>[...r[11]||=[t(` 删除 `,-1)]]),_:1},8,[`onClick`])):s(``,!0),!_(I).checkFieldPermission(e.id,`write`)&&!_(I).checkFieldPermission(e.id,`delete`)?(u(),l(`span`,M,` 无操作权限 `)):s(``,!0)]),_:1})]),_:1},8,[`data`])),[[Q,L.value]])]),_:1}),i(V,{modelValue:z.value,"onUpdate:modelValue":r[5]||=e=>z.value=e,title:G.value,width:`600px`,onClose:ae},{footer:h(()=>[c(`span`,N,[i(m,{onClick:r[4]||=e=>z.value=!1},{default:h(()=>[...r[12]||=[t(`取消`,-1)]]),_:1}),i(m,{type:`primary`,onClick:ie,loading:R.value},{default:h(()=>[...r[13]||=[t(` 确定 `,-1)]]),_:1},8,[`loading`])])]),default:h(()=>[i(B,{ref_key:`formRef`,ref:H,model:U.value,rules:W,"label-width":`120px`,loading:R.value},{default:h(()=>[i(w,{label:`字段名称`,prop:`name`},{default:h(()=>[i(C,{modelValue:U.value.name,"onUpdate:modelValue":r[0]||=e=>U.value.name=e,placeholder:`请输入字段名称`},null,8,[`modelValue`])]),_:1}),i(w,{label:`字段类型`,prop:`type`},{default:h(()=>[i(D,{modelValue:U.value.type,"onUpdate:modelValue":r[1]||=e=>U.value.type=e,placeholder:`请选择字段类型`,style:{width:`100%`}},{default:h(()=>[i(T,{label:`字符串`,value:`string`}),i(T,{label:`数字`,value:`number`}),i(T,{label:`布尔值`,value:`boolean`}),i(T,{label:`日期`,value:`date`}),i(T,{label:`日期时间`,value:`datetime`}),i(T,{label:`文本`,value:`text`}),i(T,{label:`下拉选择`,value:`select`}),i(T,{label:`多选`,value:`multiselect`})]),_:1},8,[`modelValue`])]),_:1}),i(w,{label:`必填`,prop:`required`},{default:h(()=>[i(P,{modelValue:U.value.required,"onUpdate:modelValue":r[2]||=e=>U.value.required=e},null,8,[`modelValue`])]),_:1}),U.value.type===`select`||U.value.type===`multiselect`?(u(),n(w,{key:0,label:`选项配置`,prop:`options`},{default:h(()=>[i(C,{modelValue:U.value.options,"onUpdate:modelValue":r[3]||=e=>U.value.options=e,type:`textarea`,rows:3,placeholder:`请输入选项，用逗号分隔（例如：选项1,选项2,选项3）`},null,8,[`modelValue`])]),_:1})):s(``,!0)]),_:1},8,[`model`,`loading`])]),_:1},8,[`modelValue`,`title`])])}}}),[[`__scopeId`,`data-v-9df679b3`]]);export{P as default};