import{G as e,H as t,J as n,K as r,Q as ee,S as i,V as a,W as o,X as s,Y as c,Z as l,at as u,b as d,et as f,g as p,it as m,n as h,ot as g,q as _,rt as v,tt as y,v as b,x,y as S,z as C}from"./index-DONMULiq.js";import{t as w}from"./permissions-dW7kdaip.js";var T={class:`field-permissions`},E={class:`card-header`},D={class:`header-left`},O={class:`table-name`},k={class:`header-actions`},A={key:1,class:`permission-matrix-container`},j={class:`role-header`},M={class:`permission-checkboxes`},N={class:`batch-actions`},P={class:`batch-actions-buttons`},F=h(_({__name:`FieldPermissionsView`,setup(h){let g=b(),_=S(),F=g.params.id,I=v(``),L=w(),R=v(!1),z=v(!1),B=v([]),V=[{value:`owner`,label:`Owner`},{value:`admin`,label:`Admin`},{value:`editor`,label:`Editor`},{value:`viewer`,label:`Viewer`}],H=v([]),U=()=>{H.value=B.value.map(e=>{let t={};return V.forEach(e=>{t[e.value]={canRead:!0,canWrite:e.value===`owner`||e.value===`admin`||e.value===`editor`,canDelete:e.value===`owner`||e.value===`admin`}}),{fieldId:e.id,fieldName:e.name,fieldType:e.type,permissions:t}})},W=e=>e!==`owner`&&e!==`admin`,G=async()=>{R.value=!0;try{let e=await p.getFields(F);e.success&&e.data&&(B.value=e.data.fields||[],U(),await q())}catch{x.error(`加载字段列表失败`)}finally{R.value=!1}},K=async()=>{try{let e=await p.get(F);e.success&&e.data&&(I.value=e.data.name||``)}catch(e){console.error(`Failed to load table info:`,e)}},q=async()=>{try{let e=await L.loadFieldPermissions(F);e&&e.length>0&&e.forEach(e=>{let t=H.value.find(t=>t.fieldId===e.field_id)?.permissions[e.role];t&&(t.canRead=e.can_read,t.canWrite=e.can_write,t.canDelete=e.can_delete)})}catch(e){console.error(`Failed to load existing permissions:`,e)}},J=()=>{},Y=async()=>{z.value=!0;try{let e=[];H.value.forEach(t=>{V.forEach(n=>{if(W(n.value)){let r=t.permissions[n.value];e.push({field_id:t.fieldId,role:n.value,can_read:r?.canRead??!1,can_write:r?.canWrite??!1,can_delete:r?.canDelete??!1})}})}),await L.batchSetFieldPermissions(F,e)&&x.success(`权限配置保存成功`)}catch{x.error(`保存失败`)}finally{z.value=!1}},X=()=>{d.confirm(`确定要重置所有字段权限为默认值吗？此操作将覆盖当前所有自定义权限配置。`,`确认重置`,{type:`warning`,confirmButtonText:`确定`,cancelButtonText:`取消`}).then(()=>{U(),x.success(`已重置为默认权限，请点击保存按钮保存更改`)}).catch(()=>{})},Z=e=>{H.value.forEach(t=>{V.forEach(n=>{if(W(n.value)){let r=t.permissions[n.value];r&&(r[e]=!0)}})}),x.info(`请点击保存按钮保存更改`)},Q=()=>{H.value.forEach(e=>{V.forEach(t=>{W(t.value)&&(e.permissions[t.value]={canRead:!1,canWrite:!1,canDelete:!1})})}),x.info(`请点击保存按钮保存更改`)},$=e=>{H.value.forEach(t=>{V.forEach(n=>{if(W(n.value))switch(e){case`default`:n.value===`editor`?t.permissions[n.value]={canRead:!0,canWrite:!0,canDelete:!1}:n.value===`viewer`&&(t.permissions[n.value]={canRead:!0,canWrite:!1,canDelete:!1});break;case`viewer`:t.permissions[n.value]={canRead:!0,canWrite:!1,canDelete:!1};break;case`editor`:n.value===`editor`?t.permissions[n.value]={canRead:!0,canWrite:!0,canDelete:!1}:n.value===`viewer`&&(t.permissions[n.value]={canRead:!0,canWrite:!1,canDelete:!1});break;case`strict`:n.value===`editor`?t.permissions[n.value]={canRead:!0,canWrite:!0,canDelete:!1}:n.value===`viewer`&&(t.permissions[n.value]={canRead:!1,canWrite:!1,canDelete:!1});break}})}),x.success(`已应用"${e}"模板，请点击保存按钮保存更改`)},te=e=>({string:`字符串`,number:`数字`,boolean:`布尔`,date:`日期`,datetime:`时间`,text:`文本`,select:`单选`,multiselect:`多选`})[e]||e,ne=e=>({string:``,number:`success`,boolean:`warning`,date:`info`,datetime:`info`,text:``,select:`success`,multiselect:`success`})[e]||``,re=()=>{_.push(`/tables/${F}/fields`)};return n(()=>{K(),G()}),(n,d)=>{let p=l(`el-icon`),h=l(`el-button`),g=l(`el-alert`),_=l(`el-empty`),v=l(`el-table-column`),b=l(`el-tag`),x=l(`el-checkbox`),S=l(`el-table`),w=l(`el-dropdown-item`),F=l(`el-dropdown-menu`),L=l(`el-dropdown`),U=l(`el-card`),G=ee(`loading`);return c(),o(`div`,T,[r(U,{class:`box-card`},{header:f(()=>[a(`div`,E,[a(`div`,D,[r(h,{link:``,onClick:re},{default:f(()=>[r(p,null,{default:f(()=>[r(m(i))]),_:1}),d[9]||=e(` 返回字段列表 `,-1)]),_:1}),a(`span`,O,u(I.value)+` - 字段权限配置`,1)]),a(`div`,k,[r(h,{onClick:X},{default:f(()=>[...d[10]||=[e(`重置为默认`,-1)]]),_:1}),r(h,{type:`primary`,onClick:Y,loading:z.value},{default:f(()=>[...d[11]||=[e(` 保存配置 `,-1)]]),_:1},8,[`loading`])])])]),default:f(()=>[r(g,{title:`权限说明`,type:`info`,closable:!1,style:{"margin-bottom":`20px`}},{default:f(()=>[...d[12]||=[a(`ul`,{style:{margin:`5px 0 0 20px`,padding:`0`}},[a(`li`,null,[a(`strong`,null,`R (Read)`),e(`: 读取权限 - 允许查看字段内容`)]),a(`li`,null,[a(`strong`,null,`W (Write)`),e(`: 写入权限 - 允许编辑字段内容`)]),a(`li`,null,[a(`strong`,null,`D (Delete)`),e(`: 删除权限 - 允许删除字段`)]),a(`li`,null,`未配置时使用默认权限：Owner/Admin 全部权限，Editor 可读写，Viewer 仅读取`)],-1)]]),_:1}),B.value.length===0?(c(),t(_,{key:0,description:`暂无字段`})):(c(),o(`div`,A,[y((c(),t(S,{data:H.value,border:``,style:{width:`100%`}},{default:f(()=>[r(v,{prop:`fieldName`,label:`字段名称`,"min-width":`150`,fixed:``}),r(v,{prop:`fieldType`,label:`字段类型`,width:`100`},{default:f(({row:t})=>[r(b,{type:ne(t.fieldType),size:`small`},{default:f(()=>[e(u(te(t.fieldType)),1)]),_:2},1032,[`type`])]),_:1}),(c(),o(C,null,s(V,t=>r(v,{key:t.value,label:t.label,"min-width":`120`},{header:f(()=>[a(`div`,j,[a(`span`,null,u(t.label),1)])]),default:f(({row:n})=>[a(`div`,M,[r(x,{modelValue:n.permissions[t.value].canRead,"onUpdate:modelValue":e=>n.permissions[t.value].canRead=e,disabled:!W(t.value),onChange:J},{default:f(()=>[...d[13]||=[e(` R `,-1)]]),_:1},8,[`modelValue`,`onUpdate:modelValue`,`disabled`]),r(x,{modelValue:n.permissions[t.value].canWrite,"onUpdate:modelValue":e=>n.permissions[t.value].canWrite=e,disabled:!W(t.value),onChange:J},{default:f(()=>[...d[14]||=[e(` W `,-1)]]),_:1},8,[`modelValue`,`onUpdate:modelValue`,`disabled`]),r(x,{modelValue:n.permissions[t.value].canDelete,"onUpdate:modelValue":e=>n.permissions[t.value].canDelete=e,disabled:!W(t.value),onChange:J},{default:f(()=>[...d[15]||=[e(` D `,-1)]]),_:1},8,[`modelValue`,`onUpdate:modelValue`,`disabled`])])]),_:2},1032,[`label`])),64))]),_:1},8,[`data`])),[[G,R.value]]),a(`div`,N,[d[25]||=a(`div`,{class:`batch-actions-title`},`批量操作`,-1),a(`div`,P,[r(h,{size:`small`,onClick:d[0]||=e=>Z(`canRead`)},{default:f(()=>[...d[16]||=[e(`全选读取`,-1)]]),_:1}),r(h,{size:`small`,onClick:d[1]||=e=>Z(`canWrite`)},{default:f(()=>[...d[17]||=[e(`全选写入`,-1)]]),_:1}),r(h,{size:`small`,onClick:d[2]||=e=>Z(`canDelete`)},{default:f(()=>[...d[18]||=[e(`全选删除`,-1)]]),_:1}),r(h,{size:`small`,onClick:d[3]||=e=>Q()},{default:f(()=>[...d[19]||=[e(`清空全部`,-1)]]),_:1}),r(L,{"split-button":``,type:`primary`,size:`small`,onClick:d[8]||=e=>$(`editor`)},{dropdown:f(()=>[r(F,null,{default:f(()=>[r(w,{onClick:d[4]||=e=>$(`default`)},{default:f(()=>[...d[20]||=[e(`默认权限`,-1)]]),_:1}),r(w,{onClick:d[5]||=e=>$(`viewer`)},{default:f(()=>[...d[21]||=[e(`仅查看模式`,-1)]]),_:1}),r(w,{onClick:d[6]||=e=>$(`editor`)},{default:f(()=>[...d[22]||=[e(`编辑模式`,-1)]]),_:1}),r(w,{onClick:d[7]||=e=>$(`strict`)},{default:f(()=>[...d[23]||=[e(`严格模式`,-1)]]),_:1})]),_:1})]),default:f(()=>[d[24]||=e(` 应用模板 `,-1)]),_:1})])])]))]),_:1})])}}}),[[`__scopeId`,`data-v-b983960c`]]);export{F as default};