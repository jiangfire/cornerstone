import{B as e,G as t,H as n,J as r,K as i,Q as a,U as ee,V as o,W as s,X as c,Y as l,Z as u,_ as d,at as f,b as p,et as m,it as h,n as g,ot as _,q as v,r as y,rt as b,tt as x,u as S,x as C,z as w}from"./index-DONMULiq.js";import{t as T}from"./format-BwLcG6eA.js";var E={class:`organizations`},D={class:`card-header`},O={class:`card-header`},k={class:`dialog-footer`},A={class:`dialog-footer`},j=g(v({__name:`OrganizationsView`,setup(g){let _=b(!1),v=b(!1),j=b(!1),M=b(!1),N=b([]),P=y(),F=b(),I=b({name:``,description:``,id:``}),te={name:[{required:!0,message:`请输入组织名称`,trigger:`blur`},{min:2,max:50,message:`长度在 2-50 个字符之间`,trigger:`blur`}],description:[{max:200,message:`描述不能超过200个字符`,trigger:`blur`}]},L=b(`创建组织`),R=b(null),z=b([]),B=b(!1),V=b(!1),H=b(),U=b({user_id:``,role:`member`}),W=b(!1),G=b([]),K=b({id:``,role:``}),q=e(()=>R.value?K.value.role===`owner`||K.value.role===`admin`:!1),ne={user_id:[{required:!0,message:`请选择用户`,trigger:`change`}],role:[{required:!0,message:`请选择角色`,trigger:`change`}]},re=e=>({owner:`success`,admin:`primary`,member:`info`})[e]||`info`,J=async()=>{_.value=!0;try{let e=await S.list();e.success&&e.data&&(N.value=e.data.organizations||[])}catch{C.error(`加载组织列表失败`)}finally{_.value=!1}},Y=()=>{M.value=!1,L.value=`创建组织`,I.value={name:``,description:``,id:``},j.value=!0},ie=e=>{M.value=!0,L.value=`编辑组织`,I.value={name:e.name,description:e.description||``,id:e.id},j.value=!0},ae=e=>{p.alert(`组织名称: ${e.name}\n角色: ${e.role}\n创建时间: ${T(e.created_at)}\n描述: ${e.description||`无`}`,`组织详情`,{confirmButtonText:`确定`})},oe=async e=>{try{await p.confirm(`确定要删除组织 "${e.name}" 吗？此操作不可恢复。`,`警告`,{type:`warning`,confirmButtonText:`确定`,cancelButtonText:`取消`}),(await S.delete(e.id)).success&&(C.success(`删除成功`),await J(),R.value?.id===e.id&&Z())}catch(e){e!==`cancel`&&C.error(`删除失败`)}},se=async()=>{if(F.value)try{if(!await F.value.validate())return;v.value=!0;let e;e=M.value?await S.update(I.value.id,{name:I.value.name,description:I.value.description}):await S.create({name:I.value.name,description:I.value.description}),e.success&&(C.success(M.value?`更新成功`:`创建成功`),j.value=!1,await J())}catch{C.error(M.value?`更新失败`:`创建失败`)}finally{v.value=!1}},ce=()=>{F.value&&F.value.resetFields()},le=async e=>{K.value={id:P.user?.id||``,role:e.role},R.value=e,await X()},X=async()=>{if(R.value){B.value=!0;try{let e=await S.getMembers(R.value.id);e.success&&(z.value=e.data.members||[])}catch{C.error(`加载成员列表失败`)}finally{B.value=!1}}},Z=()=>{R.value=null,z.value=[]},Q=async()=>{if(R.value){W.value=!0;try{let e=await d.list({org_id:R.value.id});e.success&&(G.value=e.data.users||[])}catch{C.error(`加载用户列表失败`),G.value=[]}finally{W.value=!1}}},ue=async()=>{await Q(),U.value={user_id:``,role:`member`},V.value=!0},de=()=>{H.value&&H.value.resetFields(),G.value=[]},fe=async()=>{if(!(!H.value||!R.value))try{if(!await H.value.validate())return;v.value=!0,(await S.addMember(R.value.id,U.value)).success&&(C.success(`添加成员成功`),V.value=!1,await X())}catch(e){let t=e instanceof Error?e.message:`添加成员失败`;C.error(t)}finally{v.value=!1}},pe=async(e,t)=>{if(R.value)try{await p.confirm(`确定要将 ${e.username} 的角色改为 ${t} 吗？`,`确认`,{type:`warning`}),await S.updateMemberRole(R.value.id,e.id,t),C.success(`角色更新成功`),await X()}catch(e){e!==`cancel`&&C.error(`角色更新失败`),await X()}},me=async e=>{if(R.value)try{await p.confirm(`确定要移除成员 ${e.username} 吗？`,`警告`,{type:`warning`}),await S.removeMember(R.value.id,e.id),C.success(`移除成员成功`),await X()}catch(e){e!==`cancel`&&C.error(`移除成员失败`)}};return r(()=>{J()}),(e,r)=>{let d=u(`el-button`),p=u(`el-empty`),g=u(`el-table-column`),y=u(`el-tag`),b=u(`el-table`),S=u(`el-card`),C=u(`el-option`),M=u(`el-select`),P=u(`el-input`),K=u(`el-form-item`),J=u(`el-form`),X=u(`el-dialog`),$=a(`loading`);return l(),s(`div`,E,[i(S,{class:`box-card`},{header:m(()=>[o(`div`,D,[r[9]||=o(`span`,null,`组织管理`,-1),i(d,{type:`primary`,onClick:Y},{default:m(()=>[...r[8]||=[t(`新建组织`,-1)]]),_:1})])]),default:m(()=>[N.value.length===0?(l(),n(p,{key:0,description:`暂无组织，请创建您的第一个组织`},{default:m(()=>[i(d,{type:`primary`,onClick:Y},{default:m(()=>[...r[10]||=[t(`创建组织`,-1)]]),_:1})]),_:1})):x((l(),n(b,{key:1,data:N.value,style:{width:`100%`}},{default:m(()=>[i(g,{prop:`name`,label:`组织名称`,"min-width":`180`}),i(g,{prop:`role`,label:`角色`,width:`120`},{default:m(({row:e})=>[i(y,{type:re(e.role)},{default:m(()=>[t(f(e.role),1)]),_:2},1032,[`type`])]),_:1}),i(g,{prop:`created_at`,label:`创建时间`,width:`180`},{default:m(({row:e})=>[t(f(h(T)(e.created_at)),1)]),_:1}),i(g,{label:`操作`,width:`240`,fixed:`right`},{default:m(({row:e})=>[i(d,{size:`small`,onClick:t=>ae(e)},{default:m(()=>[...r[11]||=[t(`查看`,-1)]]),_:1},8,[`onClick`]),i(d,{size:`small`,type:`primary`,onClick:t=>ie(e)},{default:m(()=>[...r[12]||=[t(`编辑`,-1)]]),_:1},8,[`onClick`]),i(d,{size:`small`,type:`info`,onClick:t=>le(e)},{default:m(()=>[...r[13]||=[t(`成员管理`,-1)]]),_:1},8,[`onClick`]),i(d,{size:`small`,type:`danger`,onClick:t=>oe(e)},{default:m(()=>[...r[14]||=[t(`删除`,-1)]]),_:1},8,[`onClick`])]),_:1})]),_:1},8,[`data`])),[[$,_.value]])]),_:1}),R.value?(l(),n(S,{key:0,class:`box-card member-card`,style:{"margin-top":`16px`}},{header:m(()=>[o(`div`,O,[o(`span`,null,`成员管理 - `+f(R.value.name),1),o(`div`,null,[i(d,{link:``,onClick:Z},{default:m(()=>[...r[15]||=[t(`关闭`,-1)]]),_:1}),i(d,{type:`primary`,onClick:ue,disabled:!q.value},{default:m(()=>[...r[16]||=[t(` 添加成员 `,-1)]]),_:1},8,[`disabled`])])])]),default:m(()=>[x((l(),n(b,{data:z.value,border:``},{default:m(()=>[i(g,{prop:`username`,label:`用户名`,"min-width":`120`}),i(g,{prop:`email`,label:`邮箱`,"min-width":`180`}),i(g,{prop:`role`,label:`角色`,width:`130`},{default:m(({row:e})=>[i(M,{modelValue:e.role,"onUpdate:modelValue":t=>e.role=t,size:`small`,disabled:!q.value||e.role===`owner`,onChange:t=>pe(e,t),style:{width:`100%`}},{default:m(()=>[i(C,{label:`Owner`,value:`owner`}),i(C,{label:`Admin`,value:`admin`}),i(C,{label:`Member`,value:`member`})]),_:1},8,[`modelValue`,`onUpdate:modelValue`,`disabled`,`onChange`])]),_:1}),i(g,{prop:`joined_at`,label:`加入时间`,width:`180`},{default:m(({row:e})=>[t(f(h(T)(e.joined_at)),1)]),_:1}),i(g,{label:`操作`,width:`100`,fixed:`right`},{default:m(({row:e})=>[i(d,{type:`danger`,size:`small`,onClick:t=>me(e),disabled:!q.value||e.role===`owner`},{default:m(()=>[...r[17]||=[t(` 移除 `,-1)]]),_:1},8,[`onClick`,`disabled`])]),_:1})]),_:1},8,[`data`])),[[$,B.value]])]),_:1})):ee(``,!0),i(X,{modelValue:j.value,"onUpdate:modelValue":r[3]||=e=>j.value=e,title:L.value,width:`500px`,onClose:ce},{footer:m(()=>[o(`span`,k,[i(d,{onClick:r[2]||=e=>j.value=!1},{default:m(()=>[...r[18]||=[t(`取消`,-1)]]),_:1}),i(d,{type:`primary`,onClick:se,loading:v.value},{default:m(()=>[...r[19]||=[t(` 确定 `,-1)]]),_:1},8,[`loading`])])]),default:m(()=>[i(J,{ref_key:`formRef`,ref:F,model:I.value,rules:te,"label-width":`100px`,loading:v.value},{default:m(()=>[i(K,{label:`组织名称`,prop:`name`},{default:m(()=>[i(P,{modelValue:I.value.name,"onUpdate:modelValue":r[0]||=e=>I.value.name=e,placeholder:`请输入组织名称`},null,8,[`modelValue`])]),_:1}),i(K,{label:`描述`,prop:`description`},{default:m(()=>[i(P,{modelValue:I.value.description,"onUpdate:modelValue":r[1]||=e=>I.value.description=e,type:`textarea`,rows:3,placeholder:`请输入组织描述（可选）`},null,8,[`modelValue`])]),_:1})]),_:1},8,[`model`,`loading`])]),_:1},8,[`modelValue`,`title`]),i(X,{modelValue:V.value,"onUpdate:modelValue":r[7]||=e=>V.value=e,title:`添加成员`,width:`500px`,onClose:de},{footer:m(()=>[o(`span`,A,[i(d,{onClick:r[6]||=e=>V.value=!1},{default:m(()=>[...r[20]||=[t(`取消`,-1)]]),_:1}),i(d,{type:`primary`,onClick:fe,loading:v.value},{default:m(()=>[...r[21]||=[t(` 确定 `,-1)]]),_:1},8,[`loading`])])]),default:m(()=>[i(J,{ref_key:`addMemberFormRef`,ref:H,model:U.value,rules:ne,"label-width":`100px`,loading:v.value},{default:m(()=>[i(K,{label:`用户`,prop:`user_id`},{default:m(()=>[i(M,{modelValue:U.value.user_id,"onUpdate:modelValue":r[4]||=e=>U.value.user_id=e,filterable:``,placeholder:`搜索用户`,loading:W.value,style:{width:`100%`},onFocus:Q},{default:m(()=>[(l(!0),s(w,null,c(G.value,e=>(l(),n(C,{key:e.id,label:`${e.username} (${e.email})`,value:e.id},null,8,[`label`,`value`]))),128))]),_:1},8,[`modelValue`,`loading`])]),_:1}),i(K,{label:`角色`,prop:`role`},{default:m(()=>[i(M,{modelValue:U.value.role,"onUpdate:modelValue":r[5]||=e=>U.value.role=e,placeholder:`选择角色`,style:{width:`100%`}},{default:m(()=>[i(C,{label:`Owner`,value:`owner`}),i(C,{label:`Admin`,value:`admin`}),i(C,{label:`Member`,value:`member`})]),_:1},8,[`modelValue`])]),_:1})]),_:1},8,[`model`,`loading`])]),_:1},8,[`modelValue`])])}}}),[[`__scopeId`,`data-v-4f393a91`]]);export{j as default};