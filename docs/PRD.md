# 硬件工程数据管理平台 - 产品需求文档

**版本**: v1.0
**日期**: 2026-01-05
**状态**: 设计完成 ✅

---

## 1. 产品概述

### 1.1 产品愿景
打造一个面向硬件工程师、私有化部署、具备类Excel操作体验的结构化数据管理平台。替代分散的Excel文件，解决数据协同困难、版本混乱的问题，并通过插件系统为IT团队提供快速定制能力。

### 1.2 MVP核心目标
1. **像Excel一样简单**：通过Web界面轻松创建表、定义字段、录入数据
2. **获得数据库能力**：数据存储在PostgreSQL中，支持关联查询和分析
3. **完整数据周期**：支持从创建、录入、协作到导出的完整流程

---

## 2. 用户角色

| 角色 | 核心诉求 | 使用场景 |
|------|----------|----------|
| **硬件工程师** | 规范的协同数据管理工具 | 创建实验记录表，每日录入数据，上传附件 |
| **数据研究工程师** | 获取结构化数据源 | 通过API或导出获取数据表 |
| **IT/系统管理员** | 系统部署、用户管理、插件开发 | 部署系统、开发Python/Go插件 |
| **部门管理者** | 查看团队数据概览 | 以查看者身份访问数据 |

---

## 3. 核心功能

### 3.1 数据建模
- **创建/管理表**：新建空表，设置表名称，删除表（二次确认）
- **添加/管理字段**：配置字段名称、类型（文本、数字、日期、单选、关联记录、文件）
- **字段类型**：
  - `单行文本`：短文本输入
  - `数字`：整数或小数
  - `日期`：日期选择器
  - `单选`：下拉选择
  - `关联记录`：关联其他数据表
  - `文件`：附件上传

### 3.2 数据操作
- **网格视图**：类Excel表格，支持增删改查、筛选、排序
- **表单视图**：逐条录入数据
- **文件管理**：上传、下载文件（单文件，MVP不支持预览/版本）

### 3.3 插件系统
- **插件管理后台**：上传/编辑、配置、启用/禁用、日志查看、删除
- **执行机制**：子进程调用，JSON stdin/stdout 通信，5秒超时
- **事件钩子**：
  - `before_record_save`：保存前触发（可修改数据）
  - `after_record_save`：保存后触发（通知、审计）
  - `before_record_delete`：删除前触发（备份、校验）
- **插件绑定**：绑定到**数据库**级别，对该数据库下所有表生效

### 3.4 权限与协同（多租户）
- **核心概念**：
  - **数据库**：类似Excel文件，数据容器
  - **表**：类似Sheet
  - **组织**：支持团队协作
  - **权限绑定**：用户权限绑定在**数据库**级别
  - **用户身份**：支持用户名（username）和工号（user_code）

- **数据库模式**：
  - **个人数据库**：用户创建，手动共享
  - **组织数据库**：组织创建，成员自动继承权限

- **权限继承规则**：
  - 组织所有者 → 自动拥有组织内所有数据库的 owner 权限
  - 组织管理员 → 自动拥有组织内所有数据库的 editor 权限
  - 组织成员 → 需要手动授权
  - 系统管理员 → 拥有所有数据库的访问权限

- **权限矩阵**：

  | 角色 | 表管理 | 字段管理 | 数据操作 | 插件管理 | 数据导出 |
  |------|--------|----------|----------|----------|----------|
  | **所有者** | ✅ 创建/删除 | ✅ 创建/修改/删除 | ✅ 增删改查 | 查看日志 | 全量/分页 |
  | **编辑者** | ✅ 创建/删除 | ✅ 创建/修改/删除 | ✅ 增删改查 | ❌ | 分页导出 |
  | **查看者** | ❌ | ❌ | 👁️ 只读 | ❌ | 分页导出 |
  | **管理员** | 系统级 | 系统级 | 系统级 | 上传/启用/禁用/日志 | 系统级 |

- **业务规则**：
  - 用户创建数据库时自动成为 owner
  - owner 可添加协作者（editor/viewer），权限覆盖该数据库下所有表
  - editor 可管理数据库内所有表的结构和数据
  - viewer 只能查看数据
  - 管理员拥有系统级权限
  - 全量导出仅 owner 可用（避免性能影响）

### 3.5 编辑锁
- 当一条记录处于编辑状态时，系统对该记录进行锁定
- 其他用户编辑时将收到提示"该记录正在被XXX编辑"
- 防止编辑冲突

---

## 4. 非功能性需求

| 需求类型 | MVP要求 |
|----------|---------|
| **可用性** | 核心操作（建表、增删改查）对于熟悉Excel的用户应无需培训即可上手 |
| **可靠性** | 7x24小时运行，数据存储无丢失，核心操作失败应有明确错误提示 |
| **性能** | 单表数据量 < 10,000 条时，列表加载与筛选操作应在2秒内完成 |
| **安全性** | 1. 用户密码加密存储<br>2. 前端请求需携带身份认证令牌<br>3. Python/Go插件通过子进程隔离执行，超时5秒，异常不影响主进程 |
| **部署与维护** | 提供完整的Docker Compose部署脚本，实现一键启动 |

---

## 5. 技术方案要点

### 5.1 架构
- **架构**：B/S (Browser/Server) 架构
- **前端**：Vue 3 + TypeScript + Element Plus，提供类Excel网格视图
- **后端**：Go 1.21 (Gin/Fiber)，提供高性能RESTful API
- **数据库**：PostgreSQL 15（内嵌）
- **文件存储**：本地文件系统或MinIO

### 5.2 核心数据表（13张）
```
用户与组织层：
├─ users                    (用户表)
├─ organizations            (组织表)
├─ organization_members     (组织成员表)

数据库与权限层：
├─ databases                (数据库表 - 支持双重模式)
├─ database_access          (数据库权限表)
├─ token_blacklist          (Token黑名单)

数据结构层：
├─ tables                   (表定义)
├─ fields                   (字段定义)
├─ records                  (业务数据 - JSONB)
├─ files                    (文件元数据)

插件系统层：
├─ plugins                  (插件配置)
├─ plugin_logs              (插件日志)

并发控制层：
└─ edit_locks               (编辑锁)
```

### 5.3 关键技术点
- **UUID主键**：`usr_001`, `db_001`, `tbl_001`, `rec_001`
- **JSONB存储**：records.data 支持动态字段
- **GIN索引**：加速JSONB查询
- **物化视图**：权限缓存，5分钟刷新
- **复合索引**：支持双向查询
- **乐观锁**：version字段防并发冲突
- **插件隔离**：子进程执行，5秒超时
- **JWT黑名单**：PostgreSQL存储，SHA256哈希

---

## 6. 发布计划

### Sprint 1 (3-4周)
- 用户认证（注册/登录/JWT）
- 组织管理（创建/成员/权限）
- 数据库/表/字段管理
- 基础CRUD操作
- 文件上传/下载

### Sprint 2 (3-4周)
- 权限系统（继承逻辑）
- 插件系统（子进程执行）
- 编辑锁（乐观锁）
- 数据导出
- API文档完善

### Sprint 3 (2周)
- 性能优化（索引/物化视图）
- 监控系统（Prometheus + Grafana）
- Docker部署
- 测试覆盖

---

## 7. 成功标准

1. **功能标准**：MVP所有功能点开发完成并通过测试
2. **用户标准**：
   - 邀请5-10名硬件工程师种子用户
   - 创建至少1张与工作相关的表
   - 持续使用1个月，累积300条以上记录
   - 成功通过API/导出提供给数据研究工程师
3. **插件标准**：IT团队成功开发并部署至少1个演示插件

---

**文档状态**：
- PRD v1.0: 设计完成
- 数据库设计: DATABASE.md (完整版)
- 技术架构: ARCHITECTURE.md (6个图表)
- API设计: API.md (完整接口)

**下一步**：确认文档后，可立即开始Sprint 1开发。
